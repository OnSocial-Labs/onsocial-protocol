name: Monitor Relayer Balance

on:
  schedule:
    # Every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      threshold_testnet:
        description: 'Minimum NEAR balance for testnet relayer'
        default: '5'
      threshold_mainnet:
        description: 'Minimum NEAR balance for mainnet relayer'
        default: '20'

env:
  NEAR_TESTNET_RPC: https://test.rpc.fastnear.com
  NEAR_MAINNET_RPC: https://free.rpc.fastnear.com
  RELAYER_TESTNET: relayer.onsocial.testnet
  RELAYER_MAINNET: relayer.onsocial.near
  MIN_BALANCE_TESTNET: ${{ inputs.threshold_testnet || '5' }}
  MIN_BALANCE_MAINNET: ${{ inputs.threshold_mainnet || '20' }}

jobs:
  check-balance:
    runs-on: ubuntu-latest
    steps:
      - name: Restore previous balances
        id: cache
        uses: actions/cache/restore@v4
        with:
          path: .relayer-balances
          key: relayer-balances-${{ github.run_id }}
          restore-keys: relayer-balances-

      - name: Query relayer balances
        id: balance
        run: |
          get_balance() {
            local rpc_url=$1 account_id=$2
            local resp amount
            resp=$(curl -sf --max-time 15 "$rpc_url" \
              -H 'Content-Type: application/json' \
              -d "{\"jsonrpc\":\"2.0\",\"id\":1,\"method\":\"query\",\"params\":{\"request_type\":\"view_account\",\"finality\":\"final\",\"account_id\":\"$account_id\"}}")
            amount=$(echo "$resp" | jq -r '.result.amount // empty')
            [ -z "$amount" ] && echo "ERROR" && return 1
            python3 -c "print(f'{int(\"$amount\") / 1e24:.4f}')"
          }

          TESTNET_BAL=$(get_balance "$NEAR_TESTNET_RPC" "$RELAYER_TESTNET")
          MAINNET_BAL=$(get_balance "$NEAR_MAINNET_RPC" "$RELAYER_MAINNET")

          echo "testnet_balance=$TESTNET_BAL" >> "$GITHUB_OUTPUT"
          echo "mainnet_balance=$MAINNET_BAL" >> "$GITHUB_OUTPUT"

          # Load previous balances (if cached)
          PREV_TESTNET="unknown"
          PREV_MAINNET="unknown"
          if [ -f .relayer-balances ]; then
            PREV_TESTNET=$(grep '^testnet=' .relayer-balances | cut -d= -f2 || echo "unknown")
            PREV_MAINNET=$(grep '^mainnet=' .relayer-balances | cut -d= -f2 || echo "unknown")
          fi
          echo "prev_testnet=$PREV_TESTNET" >> "$GITHUB_OUTPUT"
          echo "prev_mainnet=$PREV_MAINNET" >> "$GITHUB_OUTPUT"

          # Save current balances for next run
          echo "testnet=$TESTNET_BAL" > .relayer-balances
          echo "mainnet=$MAINNET_BAL" >> .relayer-balances

          echo "### Relayer Balances" >> "$GITHUB_STEP_SUMMARY"
          echo "| Network | Account | Balance | Previous | Threshold |" >> "$GITHUB_STEP_SUMMARY"
          echo "|---------|---------|---------|----------|-----------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Testnet | \`$RELAYER_TESTNET\` | $TESTNET_BAL NEAR | $PREV_TESTNET NEAR | $MIN_BALANCE_TESTNET NEAR |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Mainnet | \`$RELAYER_MAINNET\` | $MAINNET_BAL NEAR | $PREV_MAINNET NEAR | $MIN_BALANCE_MAINNET NEAR |" >> "$GITHUB_STEP_SUMMARY"

          # Only alert when balance is low AND has changed since last check
          ALERTS=""
          balance_changed() {
            local curr=$1 prev=$2
            [ "$prev" = "unknown" ] && return 0  # first run ‚Äî always alert
            [ "$curr" = "ERROR" ] && return 0     # query error ‚Äî always alert
            [ "$curr" != "$prev" ]                # changed?
          }

          if [ "$TESTNET_BAL" = "ERROR" ]; then
            if balance_changed "$TESTNET_BAL" "$PREV_TESTNET"; then
              ALERTS="${ALERTS}‚ùì Could not query testnet relayer balance\n"
            fi
          elif python3 -c "exit(0 if float('$TESTNET_BAL') < float('$MIN_BALANCE_TESTNET') else 1)"; then
            if balance_changed "$TESTNET_BAL" "$PREV_TESTNET"; then
              ALERTS="${ALERTS}‚ö†Ô∏è Testnet relayer: $TESTNET_BAL NEAR (was $PREV_TESTNET, threshold $MIN_BALANCE_TESTNET)\n"
            fi
          fi

          if [ "$MAINNET_BAL" = "ERROR" ]; then
            if balance_changed "$MAINNET_BAL" "$PREV_MAINNET"; then
              ALERTS="${ALERTS}‚ùì Could not query mainnet relayer balance\n"
            fi
          elif python3 -c "exit(0 if float('$MAINNET_BAL') < float('$MIN_BALANCE_MAINNET') else 1)"; then
            if balance_changed "$MAINNET_BAL" "$PREV_MAINNET"; then
              ALERTS="${ALERTS}‚ö†Ô∏è Mainnet relayer: $MAINNET_BAL NEAR (was $PREV_MAINNET, threshold $MIN_BALANCE_MAINNET)\n"
            fi
          fi

          if [ -n "$ALERTS" ]; then
            echo "alerts<<EOF" >> "$GITHUB_OUTPUT"
            echo -e "$ALERTS" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "### ‚ö†Ô∏è Alerts" >> "$GITHUB_STEP_SUMMARY"
            echo -e "$ALERTS" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Save current balances
        uses: actions/cache/save@v4
        with:
          path: .relayer-balances
          key: relayer-balances-${{ github.run_id }}

      - name: Notify Telegram (balance changed & low)
        if: steps.balance.outputs.alerts != ''
        run: |
          TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
          CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"
          TOPIC_ID="${{ secrets.TELEGRAM_OPS_TOPIC_ID }}"
          [ -z "$TOKEN" ] || [ -z "$CHAT_ID" ] && exit 0

          ALERTS="${{ steps.balance.outputs.alerts }}"
          TEXT="üö® *Relayer Balance Alert*

          ${ALERTS}
          üí∞ Top up:
          \`near send <account> relayer.onsocial.testnet <amount> --networkId testnet\`
          \`near send <account> relayer.onsocial.near <amount> --networkId mainnet\`

          [View run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"

          # Collapse whitespace from heredoc indentation
          TEXT=$(echo "$TEXT" | sed 's/^          //g')

          # Build JSON payload ‚Äî include message_thread_id if topic is configured
          PAYLOAD="{\"chat_id\": \"$CHAT_ID\", \"text\": \"$TEXT\", \"parse_mode\": \"Markdown\""
          if [ -n "$TOPIC_ID" ]; then
            PAYLOAD="$PAYLOAD, \"message_thread_id\": $TOPIC_ID"
          fi
          PAYLOAD="$PAYLOAD}"

          curl -sf -X POST "https://api.telegram.org/bot${TOKEN}/sendMessage" \
            -H 'Content-Type: application/json' \
            -d "$PAYLOAD" || true
