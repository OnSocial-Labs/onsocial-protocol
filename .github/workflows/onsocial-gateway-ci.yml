name: Gateway CI

on:
  push:
    branches: [main]
    paths:
      - 'packages/onsocial-gateway/**'
      - '.github/workflows/onsocial-gateway-ci.yml'
      - 'pnpm-lock.yaml'
  pull_request:
    branches: [main]
    paths:
      - 'packages/onsocial-gateway/**'
      - '.github/workflows/onsocial-gateway-ci.yml'
      - 'pnpm-lock.yaml'
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

env:
  NODE_ENV: test
  CI: true

jobs:
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: onsocial
          POSTGRES_PASSWORD: onsocial
          POSTGRES_DB: onsocial
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      hasura:
        image: hasura/graphql-engine:v2.40.0
        env:
          HASURA_GRAPHQL_DATABASE_URL: postgres://onsocial:onsocial@postgres:5432/onsocial
          HASURA_GRAPHQL_ADMIN_SECRET: ci-test-secret
          HASURA_GRAPHQL_ENABLE_CONSOLE: "false"
          HASURA_GRAPHQL_DEV_MODE: "false"
          HASURA_GRAPHQL_ENABLE_TELEMETRY: "false"
        options: >-
          --health-cmd "curl -f http://localhost:8080/healthz"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 8080:8080

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to GCP (Workload Identity Federation)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: "projects/87856119115/locations/global/workloadIdentityPools/github-ci/providers/github-oidc"
          service_account: "github-ci-deploy@onsocial-protocol.iam.gserviceaccount.com"

      - name: Fetch secrets from GSM
        id: secrets
        run: |
          LIGHTHOUSE_KEY=$(gcloud secrets versions access latest --secret="LIGHTHOUSE_API_KEY")
          echo "::add-mask::$LIGHTHOUSE_KEY"
          echo "LIGHTHOUSE_API_KEY=$LIGHTHOUSE_KEY" >> "$GITHUB_ENV"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm --filter @onsocial/rpc build && pnpm --filter onsocial-gateway build

      - name: Setup database
        run: PGPASSWORD=onsocial psql -h localhost -U onsocial -d onsocial -f packages/onsocial-gateway/migrations/001_api_keys.sql

      - name: Start gateway
        run: |
          node packages/onsocial-gateway/dist/index.js &
          echo $! > /tmp/gateway.pid
          # Wait for gateway to be ready
          for i in {1..30}; do
            if curl -s http://localhost:4000/health > /dev/null 2>&1; then
              echo "Gateway is ready"
              break
            fi
            echo "Waiting for gateway... ($i/30)"
            sleep 1
          done
        env:
          PORT: 4000
          JWT_SECRET: ci-test-secret
          LIGHTHOUSE_API_KEY: ${{ env.LIGHTHOUSE_API_KEY }}
          HASURA_URL: http://localhost:8080/v1/graphql
          HASURA_ADMIN_SECRET: ci-test-secret
          NEAR_NETWORK: testnet
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_DB: onsocial
          POSTGRES_USER: onsocial
          POSTGRES_PASSWORD: onsocial
          PRICE_ORACLE_MODE: mock

      - name: Run tests
        run: pnpm --filter onsocial-gateway test
        env:
          GATEWAY_URL: http://localhost:4000
          LIGHTHOUSE_API_KEY: ${{ env.LIGHTHOUSE_API_KEY }}
          HASURA_URL: http://localhost:8080/v1/graphql
          HASURA_ADMIN_SECRET: ci-test-secret

      - name: Health check
        run: |
          echo "=== Gateway Health ==="
          curl -sf http://localhost:4000/health | jq
          echo ""
          echo "=== Public Stats ==="
          curl -sf http://localhost:4000/public/stats | jq || echo "Stats endpoint not available"

      - name: Cleanup
        if: always()
        run: |
          if [ -f /tmp/gateway.pid ]; then
            kill $(cat /tmp/gateway.pid) 2>/dev/null || true
          fi
