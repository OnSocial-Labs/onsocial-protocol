specVersion: v0.1.0
package:
  name: onsocial_events
  version: v0.7.0
  url: https://github.com/onsocial-protocol/indexers/substreams
  description: High-performance substreams indexer for OnSocial protocol events
  doc: |
    OnSocial NEAR Contract Event Indexer
    Decodes NEP-297 JSON events from core-onsocial contract logs
    Outputs to PostgreSQL via substreams-sink-sql

network: near

binaries:
  default:
    type: wasm/rust-v1
    file: ./target/wasm32-unknown-unknown/release/onsocial_substreams.wasm

protobuf:
  files:
    - core.proto
    - staking.proto
    - token.proto
    - sf/substreams/sink/database/v1/database.proto
    - sf/substreams/sink/sql/v1/service.proto
  importPaths:
    - ./proto

modules:
  # Primary module - typed output
  - name: map_core_output
    kind: map
    initialBlock: 233084800
    inputs:
      - params: string
      - source: sf.near.type.v1.Block
    output:
      type: proto:core_onsocial.v1.Output
    doc: |
      Extracts core-onsocial contract events and outputs typed protobuf messages.
      
      Output contains:
      - data_updates: Posts, profiles, settings, group content
      - storage_updates: Deposits, withdrawals, pool operations
      - group_updates: Membership, governance, proposals
      - contract_updates: Meta transactions
      - permission_updates: Access control changes

  # Core database changes output - for substreams-sink-sql (PostgreSQL)
  - name: core_db_out
    kind: map
    initialBlock: 233084800
    inputs:
      - map: map_core_output
    output:
      type: proto:sf.substreams.sink.database.v1.DatabaseChanges
    doc: |
      Converts typed Output to DatabaseChanges for SQL sink.
      Writes to: data_updates, storage_updates, group_updates,
      contract_updates, permission_updates.

  # =========================================================================
  # STAKING CONTRACT MODULES
  # =========================================================================

  # Staking events - typed output
  - name: map_staking_output
    kind: map
    initialBlock: 235546389
    inputs:
      - params: string
      - source: sf.near.type.v1.Block
    output:
      type: proto:staking.v1.StakingOutput
    doc: |
      Extracts staking contract events: lock, extend, unlock, rewards,
      credits, funding, infra, ownership, upgrades.
      14 event types with success/failure tracking.

  # Staking database changes - for substreams-sink-sql
  - name: staking_db_out
    kind: map
    initialBlock: 235546389
    inputs:
      - map: map_staking_output
    output:
      type: proto:sf.substreams.sink.database.v1.DatabaseChanges
    doc: |
      Converts StakingOutput to DatabaseChanges for SQL sink.
      Writes to: staking_events, staker_state, credit_purchases.

  # =========================================================================
  # TOKEN CONTRACT MODULES (NEP-141)
  # =========================================================================

  # Token events - typed output
  - name: map_token_output
    kind: map
    initialBlock: 234337349
    inputs:
      - params: string
      - source: sf.near.type.v1.Block
    output:
      type: proto:token.v1.TokenOutput
    doc: |
      Extracts NEP-141 standard events from token.onsocial contract:
      ft_mint, ft_burn, ft_transfer.

  # Token database changes - for substreams-sink-sql
  - name: token_db_out
    kind: map
    initialBlock: 234337349
    inputs:
      - map: map_token_output
    output:
      type: proto:sf.substreams.sink.database.v1.DatabaseChanges
    doc: |
      Converts TokenOutput to DatabaseChanges for SQL sink.
      Writes to: token_events, token_balances.

params:
  map_core_output: "contract_id=core.onsocial.testnet"
  map_staking_output: "contract_id=staking.onsocial.testnet"
  map_token_output: "contract_id=token.onsocial.testnet"

# ---------------------------------------------------------------------------
# SINK DEPLOYMENT
# ---------------------------------------------------------------------------
# Each sink module requires its own spkg (sink module is embedded in the
# package). Pack with `substreams pack` after setting `sink.module` below.
#
#   # Core (sink.module = core_db_out)
#   substreams-sink-sql run "$DATABASE_URL" \
#     onsocial-events-v0.7.0-core.spkg \
#     -e "$SUBSTREAMS_ENDPOINT" \
#     -p map_core_output=contract_id=core.onsocial.testnet \
#     --development-mode --infinite-retry
#
#   # Staking (sink.module = staking_db_out)
#   substreams-sink-sql run "$DATABASE_URL" \
#     onsocial-events-v0.7.0-staking.spkg \
#     -e "$SUBSTREAMS_ENDPOINT" \
#     -p map_staking_output=contract_id=staking.onsocial.testnet \
#     --development-mode --infinite-retry
#
#   # Token (sink.module = token_db_out)
#   substreams-sink-sql run "$DATABASE_URL" \
#     onsocial-events-v0.7.0-token.spkg \
#     -e "$SUBSTREAMS_ENDPOINT" \
#     -p map_token_output=contract_id=token.onsocial.testnet \
#     --development-mode --infinite-retry
#
# Deployment blocks (from NEAR archival RPC):
#   staking.onsocial.testnet  → block 235546389 (Feb 6 2026, contract deploy)
#   core.onsocial.testnet     → block 233084800 (Jan 2026)
#   token.onsocial.testnet    → block 234337349 (Jan 2026)
# ---------------------------------------------------------------------------
sink:
  module: core_db_out
  type: sf.substreams.sink.sql.v1.Service
  config:
    schema: "./core_schema.sql"
