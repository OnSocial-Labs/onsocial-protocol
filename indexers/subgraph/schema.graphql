"""
Data updates (profiles, posts, settings, etc.)
"""
type DataUpdate @entity(immutable: true) {
  id: ID!
  blockHeight: BigInt! @index
  blockTimestamp: BigInt! @index
  receiptId: String! @index

  operation: String! @index
  author: String! @index
  partitionId: Int @index

  path: String! @index
  value: String

  # Derived from path
  accountId: String! @index
  dataType: String @index
  dataId: String

  account: Account!
}

"""
Storage updates (deposits, withdrawals, charges)
"""
type StorageUpdate @entity(immutable: true) {
  id: ID!
  blockHeight: BigInt! @index
  blockTimestamp: BigInt! @index
  receiptId: String! @index

  operation: String! @index
  author: String! @index
  partitionId: Int @index

  amount: BigInt
  previousBalance: BigInt
  newBalance: BigInt

  account: Account!
}

"""
Group updates (membership, governance)
"""
type GroupUpdate @entity(immutable: true) {
  id: ID!
  blockHeight: BigInt! @index
  blockTimestamp: BigInt! @index
  receiptId: String! @index

  operation: String! @index
  author: String! @index
  partitionId: Int @index

  groupId: String @index
  memberId: String @index
  role: String

  group: Group
}

"""
Contract updates (admin, status changes)
"""
type ContractUpdate @entity(immutable: true) {
  id: ID!
  blockHeight: BigInt! @index
  blockTimestamp: BigInt! @index
  receiptId: String! @index

  operation: String! @index
  author: String! @index
  partitionId: Int @index

  field: String
  oldValue: String
  newValue: String
}

"""
Permission updates (grants, revokes)
"""
type PermissionUpdate @entity(immutable: true) {
  id: ID!
  blockHeight: BigInt! @index
  blockTimestamp: BigInt! @index
  receiptId: String! @index

  operation: String! @index
  author: String! @index
  partitionId: Int @index

  grantee: String @index
  path: String @index
  permission: String
}

"""
Account aggregate (mutable - tracks running balances and counts)
"""
type Account @entity(immutable: false) {
  id: ID!

  storageBalance: BigInt!

  dataUpdates: [DataUpdate!]! @derivedFrom(field: "account")
  storageUpdates: [StorageUpdate!]! @derivedFrom(field: "account")

  firstSeenAt: BigInt!
  lastActiveAt: BigInt! @index

  dataUpdateCount: Int!
  storageUpdateCount: Int!
}

"""
Group aggregate (mutable - tracks group stats)
"""
type Group @entity(immutable: false) {
  id: ID!

  owner: String @index
  createdAt: BigInt!
  lastActivityAt: BigInt! @index

  memberCount: Int!
  updateCount: Int!

  updates: [GroupUpdate!]! @derivedFrom(field: "group")
}
