# OnSocial Production Caddyfile
# Auto-TLS via Let's Encrypt
#
# SINGLE PUBLIC ENTRY POINT — only the API gateway is exposed.
# Hasura, Relay, and Postgres are internal-only (Docker network).
# Admin access: SSH tunnel to the server for Hasura Console or Postgres.
#
#   ssh -L 8080:localhost:8080 your-server   # Hasura Console
#   ssh -L 5432:localhost:5432 your-server   # Postgres
#
# DNS record required (A record → server IP):
#   api.onsocial.id

# ---------- API Gateway (sole public surface) ----------
api.onsocial.id {
	# 100 req/s per IP — protects infra before requests reach the app
	rate_limit {
		zone per_ip {
			key    {remote_host}
			events 100
			window 1s
		}
	}

	reverse_proxy gateway:8080

	header {
		X-Content-Type-Options "nosniff"
		X-Frame-Options "DENY"
		Referrer-Policy "strict-origin-when-cross-origin"
		Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
		-Server
	}

	request_body {
		max_size 10MB
	}

	log {
		output file /data/logs/gateway.log {
			roll_size 50MB
			roll_keep 5
		}
	}
}
